{% extends "reseller_base.html" %}

{% block title %}Dashboard Reseller{% endblock %}
{% block header_title %}Dashboard Reseller{% endblock %}

{% block content %}
<!-- STATS -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="bg-indigo-600 p-6 rounded-2xl shadow-lg border border-transparent text-white">
        <div class="text-xs opacity-80 uppercase tracking-wider font-bold mb-2">Saldo Deposit</div>
        <div class="text-3xl font-extrabold">Rp {{ "{:,}".format(current_user.deposit_balance or 0) }}</div>
        {% if current_user.deposit_expires_at %}
        {% set now = current_user.deposit_expires_at.__class__.utcnow() %}
        {% set days_remaining = ((current_user.deposit_expires_at - now).days) if current_user.deposit_expires_at > now
        else 0 %}
        <div class="mt-4 pt-4 border-t border-white/20">
            <div class="flex items-center justify-between">
                <div>
                    <div class="text-[10px] opacity-70 uppercase tracking-wider">Berlaku Sampai</div>
                    <div class="text-sm font-bold">{{ current_user.deposit_expires_at.strftime('%d %b %Y') }}</div>
                </div>
                <div class="text-right">
                    <div class="text-[10px] opacity-70 uppercase tracking-wider">Sisa Hari</div>
                    <div class="text-2xl font-extrabold {% if days_remaining <= 30 %}text-yellow-300{% endif %}">
                        {{ days_remaining }}
                    </div>
                </div>
            </div>
            {% if days_remaining <= 30 and days_remaining> 0 %}
                <div class="mt-3 text-xs bg-yellow-500/20 text-yellow-200 px-3 py-2 rounded-lg">
                    ⚠️ Deposit akan segera berakhir. Segera top-up untuk perpanjangan.
                </div>
                {% elif days_remaining <= 0 %} <div
                    class="mt-3 text-xs bg-red-500/20 text-red-200 px-3 py-2 rounded-lg">
                    ❌ Deposit telah berakhir. Silakan top-up untuk mengaktifkan kembali.
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>

<div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800">
    <div class="text-xs text-slate-500 uppercase tracking-wider font-bold mb-2">Total Pesanan</div>
    <div class="text-3xl font-extrabold text-slate-800 dark:text-white">{{ orders|length }}</div>
</div>

<div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800">
    <div class="text-xs text-slate-500 uppercase tracking-wider font-bold mb-2">Pesanan Lunas</div>
    <div class="text-3xl font-extrabold text-green-600">
        {{ orders|selectattr('payment_status', 'equalto', 'paid')|list|length }}
    </div>
</div>

<div class="bg-white dark:bg-slate-900 p-6 rounded-2xl shadow-sm border border-slate-200 dark:border-slate-800">
    <div class="text-xs text-slate-500 uppercase tracking-wider font-bold mb-2">Total Omzet</div>
    <div class="text-3xl font-extrabold text-indigo-600">
        Rp {{ "{:,}".format(orders|selectattr('payment_status', 'equalto', 'paid')|sum(attribute='total_price')) }}
    </div>
</div>
</div>

<div class="grid grid-cols-1 gap-8">
    <!-- RIWAYAT PESANAN -->
    <div
        class="bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 overflow-hidden shadow-sm">
        <div
            class="px-6 py-4 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/20">
            <h2 class="font-bold text-slate-800 dark:text-white uppercase text-xs tracking-widest">Riwayat Pesanan
                Terbaru</h2>
            <a href="{{ url_for('main.reseller_order') }}"
                class="text-xs font-bold text-indigo-600 hover:text-indigo-800 dark:text-indigo-400">Buat Pesanan Baru
                →</a>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr
                        class="bg-slate-50 dark:bg-slate-800/50 text-slate-500 text-[10px] uppercase font-bold tracking-widest">
                        <th class="px-6 py-4">Invoice / ID</th>
                        <th class="px-6 py-4">Pelanggan</th>
                        <th class="px-6 py-4">Tgl Kunjungan</th>
                        <th class="px-6 py-4">Total</th>
                        <th class="px-6 py-4">Status</th>
                        <th class="px-6 py-4 text-right">Aksi</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100 dark:divide-slate-800">
                    {% for order in orders[:10] %}
                    <tr class="hover:bg-slate-50/50 dark:hover:bg-slate-800/30 transition-colors text-sm">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="font-bold text-slate-700 dark:text-slate-200">{{ order.invoice_number }}</div>
                            <div class="text-[10px] text-slate-400 font-mono">{{ order.uuid[:8] }}...</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="font-medium">{{ order.customer_name }}</div>
                            <div class="text-xs text-slate-500">{{ order.customer_phone }}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm">{{ order.visit_date }}</div>
                            <div class="text-[10px] text-slate-400 uppercase tracking-tighter">{{ order.visit_type|title
                                }}</div>
                        </td>
                        <td class="px-6 py-4 font-bold text-slate-800 dark:text-white">
                            Rp {{ "{:,}".format(order.total_price) }}
                        </td>
                        <td class="px-6 py-4">
                            {% if order.payment_status == 'paid' %}
                            <span
                                class="px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400">Paid</span>
                            {% elif order.payment_status == 'expired' %}
                            <span
                                class="px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400">Expired</span>
                            {% else %}
                            <span
                                class="px-2 py-1 rounded text-[10px] font-bold uppercase tracking-wider bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400">Pending</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 text-right">
                            <a href="{{ url_for('main.payment_page', uuid=order.uuid) }}"
                                class="inline-flex items-center gap-1.5 text-indigo-600 hover:text-indigo-800 dark:text-indigo-400 font-bold text-xs">
                                <span>Detail</span>
                                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                    <polyline points="15 3 21 3 21 9"></polyline>
                                    <line x1="10" y1="14" x2="21" y2="3"></line>
                                </svg>
                            </a>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center text-slate-500 italic">
                            Belum ada pesanan yang tercatat.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}